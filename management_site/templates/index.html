<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pipe Command Center</title>
    <style>
      :root {
        --bg:#0b0c0f; --fg:#e7e9ee; --muted:#9aa1aa; --card:#13151a; --line:#222531;
        --accent:#22d3ee; --accent2:#a78bfa; --danger:#ef4444; --success:#10b981;
      }
      [data-theme="light"] {
        --bg:#f6f7fb; --fg:#0b0c0f; --muted:#5b6470; --card:#ffffff; --line:#e6e7eb;
        --accent:#2563eb; --accent2:#7c3aed; --danger:#dc2626; --success:#059669;
      }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background:var(--bg); color:var(--fg); }
      .wrap { max-width: 1200px; margin: 28px auto; padding: 0 20px; }
      .header { background: linear-gradient(135deg, #10131a, #0d1117); border: 1px solid var(--line); border-radius: 14px; padding: 18px 20px; display:flex; align-items:center; justify-content:space-between; }
      *, *::before, *::after { box-sizing: border-box; }
      .brand { font-weight: 800; letter-spacing: 0.4px; }
      .brand span { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; background-clip: text; color: transparent; }

      .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
      .btn { background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b0b0c; font-weight: 800; border:0; padding: 9px 12px; border-radius: 999px; cursor:pointer; text-decoration:none; font-size:12px; }
      .btn-outline { background:transparent; border:1px solid var(--line); color:var(--fg); }
      .btn-ghost { background:transparent; color:var(--muted); }

      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:20px; margin-top:20px; align-items:stretch; }
      .card { background:var(--card); border-radius: 14px; padding: 18px; border:1px solid var(--line); display:flex; flex-direction:column; box-shadow: 0 6px 24px rgba(0,0,0,.25); transition: transform .18s ease, box-shadow .18s ease, background .18s ease; }
      .card:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,.35); }
      h2 { font-size: 16px; margin: 0 0 12px; color: var(--accent); letter-spacing: .3px; }
      .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }
      form { display:flex; flex-direction:column; gap:10px; margin: 4px 0; }
      label { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; }
      input[type="text"], input[type="number"], input[type="file"] { width: 100%; max-width: 100%; background:#0c0e13; border:1px solid #252a36; color:var(--fg); padding:10px 12px; border-radius: 10px; }
      select { width: 100%; max-width: 100%; background:#0c0e13; border:1px solid #252a36; color:var(--fg); padding:10px 12px; border-radius: 10px; appearance:none; -webkit-appearance:none; color-scheme: dark; }
      input[type="submit"], button:not(.btn) { background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b0b0c; font-weight: 800; border:0; padding: 11px 14px; border-radius: 10px; cursor:pointer; }
      input[type="submit"] { width: 100%; display:block; max-width: 100%; }
      form input, form select, form button { max-width: 100%; }
      .row { display:flex; gap:10px; }
      .row > * { flex:1; }
      .alert { white-space: pre-wrap; padding: 12px; background: #0b1214; border: 1px solid #1f2937; border-radius: 10px; margin: 10px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
      .success { border-color:#064e3b; background:#071a17; }
      .error { border-color:#7f1d1d; background:#190b0b; }
      .footer { text-align:center; color:#6b7280; font-size:12px; margin-top:20px; }
      progress { height: 12px; }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .row { flex-direction:column; } }

      /* Fancy toggle switch */
      .switch { position: relative; display:inline-block; width: 42px; height: 24px; }
      .switch input { display:none; }
      .switch .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#141820; border:1px solid #2a2f3c; transition:.2s; border-radius:999px; }
      .switch .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; top:2.2px; background:#9aa1aa; border-radius:50%; transition:.2s; }
      .switch input:checked + .slider { background: linear-gradient(135deg, var(--accent), var(--accent2)); border-color: transparent; }
      .switch input:checked + .slider:before { transform: translateX(18px); background:#0b0b0c; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="brand">PIPE <span>COMMAND CENTER</span></div>
        <div class="toolbar">
          <form method="get" action="/usage"><button class="btn btn-outline" type="submit">Usage</button></form>
          <form method="get" action="/referrals"><button class="btn btn-outline" type="submit">Referral Stats</button></form>
          <button class="btn-ghost" id="themeToggle" type="button" title="Toggle theme">ðŸŒ“</button>
          <div style="font-size:12px; color:var(--muted)">Port 3001 â€¢ by shair</div>
        </div>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="card">
            <h2>Console</h2>
            {% for category, msg in messages %}
              <div class="alert {{ category }}" style="overflow:auto; max-height: 260px;">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="grid">
        <div class="card">
          <h2>Swap SOL â†’ PIPE</h2>
          <form method="post" action="/deposit">
            <label>Amount (SOL)</label>
            <input type="text" name="amount" placeholder="0.5" required />
            <input type="submit" value="Swap" />
          </form>
          <div class="hint">Need SOL? Get Devnet SOL from the <a href="https://faucet.solana.com/" target="_blank" rel="noreferrer">Solana Faucet</a>.</div>
        </div>

        <div class="card">
          <h2>Upload</h2>
          <form method="post" action="/upload_local" enctype="multipart/form-data" id="localForm">
            <label>Pick a file (from your computer)</label>
            <input type="file" name="file" />
            <div class="row" style="align-items:center">
              <label style="flex:none;">Custom name?</label>
              <label class="switch" style="flex:none;">
                <input type="checkbox" id="toggleLocalName" />
                <span class="slider"></span>
              </label>
              <div id="localNameWrap" style="display:none; flex:1;">
                <label>Save as (on Pipe)</label>
                <input type="text" name="desired_name" placeholder="movie.mkv" />
              </div>
            </div>
            <div class="row" style="align-items:center">
              <progress id="localProgress" max="100" value="0" style="width:100%; display:none"></progress>
              <input type="submit" value="Upload" />
            </div>
          </form>

          <form method="post" action="/upload_gdrive" id="gdriveForm">
            <label>Import from Google Drive URL</label>
            <input type="text" name="gdrive_url" placeholder="https://drive.google.com/..." />
            <div class="row" style="align-items:center">
              <label style="flex:none;">Custom name?</label>
              <label class="switch" style="flex:none;">
                <input type="checkbox" id="toggleGName" />
                <span class="slider"></span>
              </label>
              <div id="gNameWrap" style="display:none; flex:1;">
                <label>Save as (on Pipe)</label>
                <input type="text" name="desired_name_g" placeholder="movie.mp4" />
              </div>
            </div>
            <input type="submit" value="Import + Upload" />
          </form>
          <div class="hint">Local copies stored under <code>~/uploads</code>. Donâ€™t upload confidential files.</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Public Link</h2>
          <form method="post" action="/public_link">
            <label>Choose from previous uploads</label>
            <select name="public_file_name">
              {% if uploads and uploads|length > 0 %}
                {% for u in uploads %}
                  <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              {% else %}
                <option value="">No uploads listed yet</option>
              {% endif %}
            </select>
            <div class="hint">Or type manually:</div>
            <input type="text" name="public_file_name_manual" placeholder="movie.mkv" />
            <input type="submit" value="Create Link" />
          </form>
          <div class="hint">Generates a shareable direct and preview link.</div>
          {% if link_history and link_history|length > 0 %}
            <hr style="border:0; border-top:1px solid #222531; margin:12px 0;" />
            <h2>Link History</h2>
            <table style="width:100%; border-collapse:collapse; font-size:12px">
              <thead>
                <tr style="text-align:left; border-bottom:1px solid #222531">
                  <th style="padding:6px 4px">File</th>
                  <th style="padding:6px 4px">Direct</th>
                  <th style="padding:6px 4px">Preview</th>
                  <th style="padding:6px 4px; white-space:nowrap">Timestamp (UTC)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in link_history %}
                  <tr style="border-bottom:1px solid #1a1d27">
                    <td style="padding:6px 4px; font-weight:700">{{ item.file }}</td>
                    <td style="padding:6px 4px">
                      {% if item.direct %}
                        <a href="{{ item.direct }}" target="_blank" rel="noreferrer">Open</a>
                      {% else %}
                        <span class="hint">â€”</span>
                      {% endif %}
                    </td>
                    <td style="padding:6px 4px">
                      {% if item.preview %}
                        <a href="{{ item.preview }}" target="_blank" rel="noreferrer">Open</a>
                      {% else %}
                        <span class="hint">â€”</span>
                      {% endif %}
                    </td>
                    <td style="padding:6px 4px">{{ item.ts }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>

        <div class="card">
          <h2>Usage & Referrals</h2>
          <form method="get" action="/usage">
            <input type="submit" value="Show Token Usage (30d)" />
          </form>
          <form method="get" action="/referrals" style="margin-top:6px">
            <input type="submit" value="Show Referral Stats" />
          </form>
          <div class="hint">View your usage and referral stats.</div>
          <hr style="border:0; border-top:1px solid #222531; margin:12px 0;" />
          <h2>Command Runner</h2>
          <form method="post" action="/run">
            <label>Run a Pipe command</label>
            <input type="text" name="cmd" placeholder="pipe list-uploads" />
            <input type="submit" value="Run" />
          </form>
          <form method="post" action="/quick/list-uploads" style="margin-top:6px">
            <input type="submit" value="Quick: pipe list-uploads" />
          </form>
          <div class="hint">Restricted to Pipe commands.</div>
          <hr style="border:0; border-top:1px solid #222531; margin:12px 0;" />
          <h2>Download (streamable)</h2>
          <form method="post" action="/download">
            <label>Choose from previous uploads</label>
            <select name="remote_name_select">
              {% if uploads and uploads|length > 0 %}
                {% for u in uploads %}
                  <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              {% else %}
                <option value="">No uploads listed yet</option>
              {% endif %}
            </select>
            <div class="hint">Or type manually:</div>
            <input type="text" name="remote_name_manual" placeholder="my-photo" />
            <label>Save locally as</label>
            <input type="text" name="local_name" placeholder="downloaded-photo.jpg" />
            <div class="row" style="align-items:center">
              <label style="flex:none;">Use legacy endpoint?</label>
              <label class="switch" style="flex:none;">
                <input type="checkbox" name="legacy" />
                <span class="slider"></span>
              </label>
            </div>
            <input type="submit" value="Download" />
          </form>
          <div class="hint">Downloaded files are saved to <code>~/downloads</code>.</div>
        </div>
      </div>

      <div class="footer">Keep this tab open while managing. </div>
    </div>
    <script>
      (function(){
        const toggleLocal = document.getElementById('toggleLocalName');
        const localWrap = document.getElementById('localNameWrap');
        const localInput = document.querySelector('#localNameWrap input[name="desired_name"]');
        const localFile = document.querySelector('form#localForm input[type="file"]');
        if (toggleLocal && localWrap) {
          toggleLocal.addEventListener('change', () => {
            const on = toggleLocal.checked;
            localWrap.style.display = on ? 'block' : 'none';
            if (on && localInput && localFile && localFile.files && localFile.files[0]) {
              if (!localInput.value) localInput.value = localFile.files[0].name;
            }
          });
        }
        if (localFile) {
          localFile.addEventListener('change', () => {
            if (toggleLocal && toggleLocal.checked && localInput && localFile.files && localFile.files[0]) {
              localInput.value = localFile.files[0].name;
            }
          });
        }

        const toggleG = document.getElementById('toggleGName');
        const gWrap = document.getElementById('gNameWrap');
        if (toggleG && gWrap) {
          toggleG.addEventListener('change', () => {
            gWrap.style.display = toggleG.checked ? 'block' : 'none';
          });
        }

        // Local upload progress bar (AJAX submit)
        const localForm = document.getElementById('localForm');
        const localProgress = document.getElementById('localProgress');
        if (localForm && localProgress) {
          localForm.addEventListener('submit', (ev) => {
            const fileInput = localForm.querySelector('input[type="file"]');
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return; // normal submit
            ev.preventDefault();
            const formData = new FormData(localForm);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', localForm.action);
            xhr.upload.addEventListener('progress', (e) => {
              if (e.lengthComputable) {
                const pct = Math.round((e.loaded / e.total) * 100);
                localProgress.style.display = 'block';
                localProgress.value = pct;
              }
            });
            xhr.onreadystatechange = () => {
              if (xhr.readyState === 4) {
                localProgress.value = 0;
                localProgress.style.display = 'none';
                // reload to show flash messages
                window.location.reload();
              }
            };
            xhr.send(formData);
          });
        }

        // Theme toggle with localStorage
        const themeToggle = document.getElementById('themeToggle');
        const applyTheme = (t) => {
          if (t === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
          } else {
            document.documentElement.removeAttribute('data-theme');
          }
        };
        const savedTheme = localStorage.getItem('theme');
        applyTheme(savedTheme);
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
            const next = current === 'light' ? 'dark' : 'light';
            applyTheme(next);
            localStorage.setItem('theme', next);
          });
        }
      })();
    </script>
  </body>
  </html>



